<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-PROSEDUR - Direktorat Operation Dept Supplay Chain</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React & Babel CDN untuk menjalankan JSX di browser -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .animate-fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#F0F2F5]">
    <div id="root"></div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global Firebase logic for the React component
        window.FB = { initializeApp, getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, query, getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged };
    </script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // Fallback config jika tidak ada variabel lingkungan
        const firebaseConfig = typeof __firebase_config !== 'undefined' 
            ? JSON.parse(__firebase_config) 
            : {
                apiKey: "PASTE_YOUR_API_KEY_HERE",
                authDomain: "YOUR_PROJECT.firebaseapp.com",
                projectId: "YOUR_PROJECT_ID",
                storageBucket: "YOUR_PROJECT.appspot.com",
                messagingSenderId: "YOUR_SENDER_ID",
                appId: "YOUR_APP_ID"
            };

        const GD_FOLDER_URL = "https://drive.google.com/drive/folders/1oPrp8f0knk7G1VsGCwu_8GWGf1Fe7MgZ";

        function App() {
            const [user, setUser] = useState(null);
            const [isAdmin, setIsAdmin] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [documents, setDocuments] = useState([]);
            const [loading, setLoading] = useState(true);
            const [searchTerm, setSearchTerm] = useState('');
            const [showPassword, setShowPassword] = useState(false);
            const [loginForm, setLoginForm] = useState({ username: '', password: '' });
            const [loginError, setLoginError] = useState('');
            const [selectedFile, setSelectedFile] = useState(null);
            const [isUploading, setIsUploading] = useState(false);
            const [uploadProgress, setUploadProgress] = useState(0);
            const fileInputRef = useRef(null);
            
            const [formData, setFormData] = useState({
                judul: '', jenis: 'SOP', departemen: '', link: '',
                update: new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' })
            });

            // Firebase Instance
            const [db, setDb] = useState(null);
            const [auth, setAuth] = useState(null);
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-sop-app';

            useEffect(() => {
                const { initializeApp, getFirestore, getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged } = window.FB;
                const app = initializeApp(firebaseConfig);
                const _db = getFirestore(app);
                const _auth = getAuth(app);
                setDb(_db);
                setAuth(_auth);

                const initAuth = async () => {
                    try {
                        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                            await signInWithCustomToken(_auth, __initial_auth_token);
                        } else {
                            await signInAnonymously(_auth);
                        }
                    } catch (error) { console.error("Auth error:", error); }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(_auth, setUser);
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user || !db) return;
                const { collection, query, onSnapshot } = window.FB;
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'documents'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    setDocuments(snapshot.docs.map(d => ({ id: d.id, ...d.data() })));
                    setLoading(false);
                }, (err) => { console.error(err); setLoading(false); });
                return () => unsubscribe();
            }, [user, db]);

            const groupedDocs = useMemo(() => {
                const filtered = documents.filter(doc => 
                    doc.judul.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    doc.departemen.toLowerCase().includes(searchTerm.toLowerCase())
                );
                const depts = [...new Set(filtered.map(d => d.departemen))].sort();
                return depts.map(dept => ({
                    name: dept,
                    categories: [
                        { type: "SOP (Standard Operating Procedure)", items: filtered.filter(d => d.departemen === dept && d.jenis === "SOP") },
                        { type: "IK (Instruksi Kerja)", items: filtered.filter(d => d.departemen === dept && d.jenis === "IK") }
                    ].filter(cat => cat.items.length > 0)
                }));
            }, [documents, searchTerm]);

            const handleLogin = (e) => {
                e.preventDefault();
                if (loginForm.username === 'admin' && loginForm.password === 'admin123') {
                    setIsAdmin(true); setShowLoginModal(false); setLoginError('');
                } else { setLoginError('NIP atau Password salah!'); }
            };

            const handleFileChange = (e) => {
                const file = e.target.files[0];
                if (file?.type === "application/pdf") {
                    setSelectedFile(file);
                    if (!formData.judul) setFormData(p => ({ ...p, judul: file.name.replace(".pdf", "") }));
                } else { alert("Pilih file PDF!"); }
            };

            const handleAdd = async (e) => {
                e.preventDefault();
                if (!user || isUploading) return;
                setIsUploading(true);
                setUploadProgress(20);
                
                // Simu upload
                setTimeout(async () => {
                    setUploadProgress(100);
                    const { collection, addDoc } = window.FB;
                    const finalLink = formData.link || `${GD_FOLDER_URL}?q=${encodeURIComponent(selectedFile?.name || 'manual')}`;
                    try {
                        await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'documents'), {
                            ...formData, link: finalLink, createdAt: new Date().toISOString()
                        });
                        setFormData({ judul: '', jenis: 'SOP', departemen: '', link: '', update: new Date().toLocaleDateString('id-ID', { day: '2-digit', month: 'short', year: 'numeric' }) });
                        setSelectedFile(null);
                    } catch (err) { console.error(err); }
                    setIsUploading(false);
                }, 1500);
            };

            const handleDelete = async (id) => {
                if (!window.confirm("Hapus dokumen?")) return;
                const { doc, deleteDoc } = window.FB;
                await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'documents', id));
            };

            return (
                <div className="min-h-screen pb-20">
                    <nav className="bg-[#003366] sticky top-0 z-20 shadow-lg border-b-4 border-[#FFCC00]">
                        <div className="max-w-6xl mx-auto px-6 py-3 flex flex-col md:flex-row items-center justify-between gap-4">
                            <div className="flex items-center gap-4 text-white">
                                <div className="bg-[#FFCC00] p-2 rounded-lg"><i data-lucide="shield-check" class="text-[#003366]"></i></div>
                                <div>
                                    <h1 className="text-lg font-black leading-none">E-PROSEDUR</h1>
                                    <p className="text-[10px] text-[#FFCC00] mt-1 font-bold uppercase tracking-widest">Direktorat Operation Dept Supplay Chain</p>
                                </div>
                            </div>
                            <div className="flex items-center gap-3 w-full md:w-auto">
                                <div className="relative flex-1 md:w-64">
                                    <input type="text" placeholder="Cari..." className="w-full pl-4 pr-4 py-2 rounded text-sm outline-none focus:ring-2 focus:ring-[#FFCC00]" value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
                                </div>
                                <button onClick={() => isAdmin ? setIsAdmin(false) : setShowLoginModal(true)} className="px-4 py-2 bg-[#FFCC00] text-[#003366] rounded font-bold text-sm shadow-md transition-all">
                                    {isAdmin ? 'Logout Admin' : 'Admin'}
                                </button>
                            </div>
                        </div>
                    </nav>

                    {showLoginModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                            <form onSubmit={handleLogin} className="bg-white rounded-xl shadow-2xl w-full max-w-md border-t-8 border-[#FFCC00] p-8 animate-fade-in">
                                <h2 className="text-xl font-black text-[#003366] mb-6 uppercase">Login Otentikasi</h2>
                                {loginError && <p className="text-red-500 text-xs font-bold mb-4">{loginError}</p>}
                                <input required type="text" placeholder="Username (admin)" className="w-full mb-4 p-3 bg-slate-50 border rounded outline-none focus:ring-2 focus:ring-[#003366]" value={loginForm.username} onChange={e => setLoginForm({...loginForm, username: e.target.value})} />
                                <div className="relative mb-6">
                                    <input required type={showPassword ? "text" : "password"} placeholder="Password (admin123)" className="w-full p-3 bg-slate-50 border rounded outline-none focus:ring-2 focus:ring-[#003366]" value={loginForm.password} onChange={e => setLoginForm({...loginForm, password: e.target.value})} />
                                    <button type="button" onClick={() => setShowPassword(!showPassword)} className="absolute right-3 top-3 text-slate-400">
                                        {showPassword ? "Hide" : "Show"}
                                    </button>
                                </div>
                                <button className="w-full bg-[#003366] text-white py-3 rounded font-black uppercase tracking-widest">Masuk Sistem</button>
                                <button type="button" onClick={() => setShowLoginModal(false)} className="w-full mt-2 text-slate-400 text-xs font-bold uppercase py-2">Batal</button>
                            </form>
                        </div>
                    )}

                    <main className="max-w-6xl mx-auto px-6 py-10">
                        {loading ? <div className="text-center py-20 text-[#003366] font-bold">Sinkronisasi Data...</div> : 
                        isAdmin ? (
                            <div className="space-y-8 animate-fade-in">
                                <div className="bg-white rounded shadow-sm overflow-hidden border">
                                    <div className="bg-[#003366] p-4 text-white font-bold text-sm uppercase">Input Berkas Baru</div>
                                    <form onSubmit={handleAdd} className="p-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="space-y-4">
                                            <input required placeholder="Judul Dokumen" className="w-full p-2.5 border rounded" value={formData.judul} onChange={e => setFormData({...formData, judul: e.target.value})} />
                                            <input required placeholder="Unit Kerja / Dept" className="w-full p-2.5 border rounded" value={formData.departemen} onChange={e => setFormData({...formData, departemen: e.target.value})} />
                                            <select className="w-full p-2.5 border rounded font-bold" value={formData.jenis} onChange={e => setFormData({...formData, jenis: e.target.value})}>
                                                <option value="SOP">SOP</option>
                                                <option value="IK">IK</option>
                                            </select>
                                        </div>
                                        <div className="border-2 border-dashed rounded-lg p-6 flex flex-col items-center justify-center bg-slate-50 cursor-pointer" onClick={() => fileInputRef.current.click()}>
                                            <input type="file" hidden ref={fileInputRef} onChange={handleFileChange} />
                                            <p className="text-sm font-bold text-[#003366]">{selectedFile ? selectedFile.name : "Klik Pilih File PDF"}</p>
                                        </div>
                                        <div className="md:col-span-2">
                                            {isUploading ? <div className="w-full bg-slate-200 h-2 rounded overflow-hidden"><div className="bg-[#003366] h-full" style={{width: `${uploadProgress}%`}}></div></div> : 
                                            <button className="bg-[#003366] text-white px-8 py-3 rounded font-black text-xs tracking-widest uppercase">Simpan & Upload</button>}
                                        </div>
                                    </form>
                                </div>
                                <div className="bg-white rounded border overflow-hidden">
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-[#003366] text-[#FFCC00] uppercase text-[10px] font-black">
                                            <tr><th className="p-4">Nama Dokumen</th><th className="p-4">Dept</th><th className="p-4">Aksi</th></tr>
                                        </thead>
                                        <tbody>
                                            {documents.map(d => (
                                                <tr key={d.id} className="border-t">
                                                    <td className="p-4 font-bold text-[#003366]">{d.judul}</td>
                                                    <td className="p-4 text-slate-500 uppercase text-xs">{d.departemen}</td>
                                                    <td className="p-4"><button onClick={() => handleDelete(d.id)} className="text-red-500 font-bold">Hapus</button></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        ) : (
                            <div className="animate-fade-in">
                                <div className="mb-12 bg-white p-10 rounded-xl border-l-8 border-[#003366] shadow-xl flex items-center gap-8">
                                    <div className="bg-[#003366] p-4 rounded-xl shadow-lg"><i data-lucide="layers" class="text-[#FFCC00] w-10 h-10"></i></div>
                                    <div>
                                        <h2 className="text-2xl font-black text-[#003366] uppercase tracking-tighter">Pusat Data Prosedur Kerja</h2>
                                        <p className="text-slate-500 text-sm mt-1 italic">Selamat datang di Sistem Manajemen SOP & Instruksi Kerja Direktorat Operation Dept Supplay Chain.</p>
                                    </div>
                                </div>

                                <div className="space-y-12">
                                    {groupedDocs.map(dept => (
                                        <div key={dept.name} className="relative">
                                            <div className="flex items-center gap-3 mb-6">
                                                <div className="h-10 w-1 bg-[#003366]"></div>
                                                <h2 className="text-xl font-black text-[#003366] uppercase">{dept.name}</h2>
                                            </div>
                                            <div className="grid grid-cols-1 md:grid-cols-2 gap-8 ml-4">
                                                {dept.categories.map(cat => (
                                                    <div key={cat.type}>
                                                        <h3 className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-4 bg-slate-100 py-1 px-3 w-fit rounded">{cat.type}</h3>
                                                        <div className="space-y-3">
                                                            {cat.items.map(item => (
                                                                <a key={item.id} href={item.link} target="_blank" className="flex items-center justify-between p-4 bg-white border rounded hover:border-[#003366] hover:shadow-lg transition-all group">
                                                                    <div className="flex items-center gap-4">
                                                                        <div className="p-2 bg-slate-50 group-hover:bg-[#003366] rounded transition-colors text-slate-400 group-hover:text-[#FFCC00]"><i data-lucide="file-text"></i></div>
                                                                        <div>
                                                                            <p className="text-sm font-bold text-[#003366] group-hover:text-black uppercase tracking-tight">{item.judul}</p>
                                                                            <p className="text-[9px] font-black text-slate-400 mt-1 uppercase tracking-widest">DIPERBARUI: {item.update}</p>
                                                                        </div>
                                                                    </div>
                                                                    <i data-lucide="external-link" class="w-4 h-4 text-[#003366] opacity-0 group-hover:opacity-100 transition-opacity"></i>
                                                                </a>
                                                            ))}
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}
                    </main>

                    <footer className="bg-[#002244] border-t-8 border-[#FFCC00] py-16 mt-20 text-center text-white">
                        <i data-lucide="shield-check" class="mx-auto mb-4 text-[#FFCC00] w-10 h-10"></i>
                        <p className="text-[#FFCC00] text-[10px] font-black uppercase tracking-[0.4em] mb-2">Dokumentasi Terpadu</p>
                        <p className="text-white/40 text-[9px] font-bold uppercase tracking-widest leading-loose">
                            Direktorat Operation Dept Supplay Chain &copy; 2024 <br/>
                            Sistem Manajemen Prosedur Kerja GuoKing_
                        </p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);

        // Refresh icons after render
        setTimeout(() => lucide.createIcons(), 500);
    </script>
</body>
</html>
